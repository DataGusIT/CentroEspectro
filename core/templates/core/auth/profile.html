{% extends 'base.html' %}
{% load static %}

{% block title %}{{ title }}{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="row">
        <div class="col-lg-3">
            <!-- Sidebar do Perfil -->
            <div class="card">
                <div class="card-body text-center">
                    <div class="profile-avatar mb-3">
                        <div class="avatar-circle">
                            <i class="fas fa-user fa-3x text-primary"></i>
                        </div>
                    </div>
                    <h5 class="card-title">{{ user.get_full_name|default:user.username }}</h5>
                    <p class="text-muted">{{ user.email }}</p>
                    <small class="text-muted">
                        Membro desde {{ user.date_joined|date:"d/m/Y" }}
                    </small>
                </div>
            </div>

            <!-- Navegação do Perfil -->
            <div class="card mt-3">
                <div class="card-body p-0">
                    <div class="list-group list-group-flush">
                        <a href="#dados-pessoais" class="list-group-item list-group-item-action active" 
                           data-bs-toggle="tab">
                            <i class="fas fa-user me-2"></i> Dados Pessoais
                        </a>
                        <a href="#duvidas-salvas" class="list-group-item list-group-item-action" 
                           data-bs-toggle="tab">
                            <i class="fas fa-bookmark me-2"></i> Dúvidas Salvas
                            <span class="badge bg-primary rounded-pill float-end">{{ duvidas_salvas.count }}</span>
                        </a>
                        <a href="#downloads" class="list-group-item list-group-item-action" 
                           data-bs-toggle="tab">
                            <i class="fas fa-download me-2"></i> Downloads
                            <span class="badge bg-secondary rounded-pill float-end">{{ downloads.count }}</span>
                        </a>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-lg-9">
            <div class="tab-content">
                <!-- Aba Dados Pessoais -->
                <div class="tab-pane fade show active" id="dados-pessoais">
                    <div class="card">
                        <div class="card-header">
                            <h5 class="mb-0">
                                <i class="fas fa-user me-2"></i>Dados Pessoais
                            </h5>
                        </div>
                        <div class="card-body">
                            <form method="post">
                                {% csrf_token %}
                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        <label for="{{ form.first_name.id_for_label }}" class="form-label">
                                            Nome
                                        </label>
                                        {{ form.first_name }}
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <label for="{{ form.last_name.id_for_label }}" class="form-label">
                                            Sobrenome
                                        </label>
                                        {{ form.last_name }}
                                    </div>
                                </div>
                                <div class="mb-3">
                                    <label for="{{ form.email.id_for_label }}" class="form-label">
                                        E-mail
                                    </label>
                                    {{ form.email }}
                                </div>
                                <div class="d-grid">
                                    <button type="submit" class="btn btn-primary">
                                        <i class="fas fa-save me-2"></i>Salvar Alterações
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>

                <!-- Aba Dúvidas Salvas -->
                <div class="tab-pane fade" id="duvidas-salvas">
                    <div class="card">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <h5 class="mb-0">
                                <i class="fas fa-bookmark me-2"></i>Minhas Dúvidas Salvas
                            </h5>
                            <span class="badge bg-primary">{{ duvidas_salvas.count }} dúvida{{ duvidas_salvas.count|pluralize:"s" }}</span>
                        </div>
                        <div class="card-body">
                            {% if duvidas_salvas %}
                                <div class="accordion" id="accordionDuvidasSalvas">
                                    {% for duvida_salva in duvidas_salvas %}
                                    <div class="accordion-item mb-3">
                                        <h2 class="accordion-header" id="heading{{ duvida_salva.id }}">
                                            <div class="d-flex align-items-center">
                                                <button class="accordion-button collapsed fw-medium flex-grow-1" 
                                                        type="button" data-bs-toggle="collapse" 
                                                        data-bs-target="#collapse{{ duvida_salva.id }}"
                                                        aria-expanded="false" 
                                                        aria-controls="collapse{{ duvida_salva.id }}">
                                                    <div class="me-3">
                                                        <span class="badge bg-primary">{{ duvida_salva.faq.categoria.nome }}</span>
                                                    </div>
                                                    <div class="flex-grow-1">
                                                        {{ duvida_salva.faq.pergunta }}
                                                    </div>
                                                </button>
                                                <div class="me-3">
                                                    <button class="btn btn-outline-danger btn-sm" 
                                                            onclick="removerDuvida({{ duvida_salva.faq.id }}, this)"
                                                            title="Remover dúvida salva">
                                                        <i class="fas fa-trash"></i>
                                                    </button>
                                                </div>
                                            </div>
                                        </h2>
                                        <div id="collapse{{ duvida_salva.id }}" 
                                             class="accordion-collapse collapse"
                                             aria-labelledby="heading{{ duvida_salva.id }}"
                                             data-bs-parent="#accordionDuvidasSalvas">
                                            <div class="accordion-body">
                                                <div class="faq-content">
                                                    {{ duvida_salva.faq.resposta|linebreaksbr|safe }}
                                                </div>
                                                <hr>
                                                <div class="d-flex justify-content-between align-items-center text-muted">
                                                    <small>
                                                        <i class="fas fa-calendar me-1"></i>
                                                        Salva em {{ duvida_salva.data_salva|date:"d/m/Y \à\s H:i" }}
                                                    </small>
                                                    <small>
                                                        <i class="fas fa-tag me-1"></i>
                                                        {{ duvida_salva.faq.categoria.nome }}
                                                    </small>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    {% endfor %}
                                </div>
                            {% else %}
                                <div class="text-center py-5">
                                    <i class="fas fa-bookmark fa-3x text-muted mb-3"></i>
                                    <h5 class="text-muted">Nenhuma dúvida salva</h5>
                                    <p class="text-muted">
                                        Você ainda não salvou nenhuma dúvida. 
                                        <a href="{% url 'duvidas' %}" class="text-decoration-none">
                                            Explore nossas dúvidas frequentes
                                        </a>
                                    </p>
                                </div>
                            {% endif %}
                        </div>
                    </div>
                </div>

                <!-- Aba Downloads -->
                <div class="tab-pane fade" id="downloads">
                    <div class="card">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <h5 class="mb-0">
                                <i class="fas fa-download me-2"></i>Meus Downloads
                            </h5>
                            <span class="badge bg-secondary">{{ downloads.count }} download{{ downloads.count|pluralize:"s" }}</span>
                        </div>
                        <div class="card-body">
                            {% if downloads %}
                                <div class="table-responsive">
                                    <table class="table table-hover">
                                        <thead>
                                            <tr>
                                                <th>Ferramenta</th>
                                                <th>Data do Download</th>
                                                <th>Ações</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {% for download in downloads %}
                                            <tr>
                                                <td>
                                                    <div class="d-flex align-items-center">
                                                        <i class="fas fa-tools text-primary me-2"></i>
                                                        <div>
                                                            <strong>{{ download.ferramenta.nome }}</strong>
                                                            <br>
                                                            <small class="text-muted">{{ download.ferramenta.categoria.nome }}</small>
                                                        </div>
                                                    </div>
                                                </td>
                                                <td>
                                                    <small>{{ download.data_download|date:"d/m/Y H:i" }}</small>
                                                </td>
                                                <td>
                                                    <a href="{% url 'detalhes_ferramenta' download.ferramenta.id %}" 
                                                       class="btn btn-sm btn-outline-primary">
                                                        <i class="fas fa-eye me-1"></i>Ver Detalhes
                                                    </a>
                                                </td>
                                            </tr>
                                            {% endfor %}
                                        </tbody>
                                    </table>
                                </div>
                            {% else %}
                                <div class="text-center py-5">
                                    <i class="fas fa-download fa-3x text-muted mb-3"></i>
                                    <h5 class="text-muted">Nenhum download realizado</h5>
                                    <p class="text-muted">
                                        Você ainda não baixou nenhuma ferramenta. 
                                        <a href="{% url 'ferramentas' %}" class="text-decoration-none">
                                            Explore nossas ferramentas
                                        </a>
                                    </p>
                                </div>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Toast container -->
<div aria-live="polite" aria-atomic="true" class="position-relative">
    <div class="toast-container position-fixed top-0 end-0 p-3">
        <div id="toastMessage" class="toast" role="alert" aria-live="assertive" aria-atomic="true">
            <div class="toast-header">
                <strong class="me-auto" id="toastTitle">Notificação</strong>
                <button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Close"></button>
            </div>
            <div class="toast-body" id="toastBody">
                Mensagem aqui
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_css %}
<style>
    .avatar-circle {
        width: 80px;
        height: 80px;
        border-radius: 50%;
        background: linear-gradient(45deg, var(--primary), var(--primary-light));
        display: flex;
        align-items: center;
        justify-content: center;
        margin: 0 auto;
    }
    
    .faq-content {
        line-height: 1.6;
    }
    
    .faq-content strong {
        color: var(--primary);
    }
    
    .accordion-button:not(.collapsed) {
        background-color: var(--primary-light);
        color: var(--primary);
    }
    
    .badge {
        font-size: 0.75em;
    }

    /* Animação para remoção de itens */
    @keyframes fadeOut {
        from { 
            opacity: 1; 
            transform: translateX(0); 
        }
        to { 
            opacity: 0; 
            transform: translateX(-100%); 
        }
    }
</style>
{% endblock %}

{% block extra_js %}
<script>
    // Função para remover dúvida salva
    function removerDuvida(faqId, element) {
        if (!confirm('Tem certeza que deseja remover esta dúvida das suas dúvidas salvas?')) {
            return;
        }
        
        const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
        
        fetch(`/remover-faq/${faqId}/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': csrfToken,
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({'faq_id': faqId})
        })
        .then(response => {
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            return response.json();
        })
        .then(data => {
            if (data.success) {
                // Remove o elemento da página
                const accordionItem = element.closest('.accordion-item');
                accordionItem.style.animation = 'fadeOut 0.5s';
                
                setTimeout(() => {
                    accordionItem.remove();
                    
                    // Atualiza o contador
                    const badge = document.querySelector('#duvidas-salvas .badge');
                    const currentCount = parseInt(badge.textContent);
                    const newCount = currentCount - 1;
                    badge.textContent = `${newCount} dúvida${newCount !== 1 ? 's' : ''}`;
                    
                    // Se não há mais dúvidas, mostra mensagem
                    if (newCount === 0) {
                        const cardBody = document.querySelector('#duvidas-salvas .card-body');
                        cardBody.innerHTML = `
                            <div class="text-center py-5">
                                <i class="fas fa-bookmark fa-3x text-muted mb-3"></i>
                                <h5 class="text-muted">Nenhuma dúvida salva</h5>
                                <p class="text-muted">
                                    Você ainda não salvou nenhuma dúvida. 
                                    <a href="/duvidas/" class="text-decoration-none">
                                        Explore nossas dúvidas frequentes
                                    </a>
                                </p>
                            </div>
                        `;
                    }
                }, 500);
                
                showToast('success', 'Dúvida removida com sucesso!');
            } else {
                showToast('error', data.message || 'Erro ao remover dúvida');
            }
        })
        .catch(error => {
            console.error('Erro completo:', error);
            showToast('error', 'Erro de conexão. Tente novamente.');
        });
    }

    // Função para mostrar toast
    function showToast(type, message) {
        const toastElement = document.getElementById('toastMessage');
        const toastTitle = document.getElementById('toastTitle');
        const toastBody = document.getElementById('toastBody');
        
        // Definir cor do toast baseado no tipo
        toastElement.className = 'toast';
        const toastHeader = toastElement.querySelector('.toast-header');
        
        switch(type) {
            case 'success':
                toastHeader.className = 'toast-header bg-success text-white';
                toastTitle.textContent = 'Sucesso';
                break;
            case 'error':
                toastHeader.className = 'toast-header bg-danger text-white';
                toastTitle.textContent = 'Erro';
                break;
            case 'warning':
                toastHeader.className = 'toast-header bg-warning text-dark';
                toastTitle.textContent = 'Atenção';
                break;
            case 'info':
                toastHeader.className = 'toast-header bg-info text-white';
                toastTitle.textContent = 'Informação';
                break;
            default:
                toastHeader.className = 'toast-header';
                toastTitle.textContent = 'Notificação';
        }
        
        toastBody.textContent = message;
        
        const toast = new bootstrap.Toast(toastElement, {
            delay: 4000
        });
        toast.show();
    }
    
    // Adicionar animação de fade out
    const style = document.createElement('style');
    style.textContent = `
        @keyframes fadeOut {
            from { opacity: 1; transform: translateX(0); }
            to { opacity: 0; transform: translateX(-100%); }
        }
    `;
    document.head.appendChild(style);
</script>
{% endblock %}