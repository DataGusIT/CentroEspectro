{% extends 'base.html' %}
{% load socialaccount %}

{% block content %}
<div class="container py-5">
    <div class="row justify-content-center">
        <div class="col-lg-10">
            <div class="card modern-card overflow-hidden">
                <div class="card-body p-0">
                    <div class="row g-0"> 
                        
                        <!-- Painel esquerdo (Desktop) -->
                        <div class="col-lg-5 d-none d-lg-block position-relative left-panel-container">
                            <div class="h-100 left-panel">
                                <!-- Padrão de fundo (Pontos) -->
                                <div class="position-absolute geometric-patterns"></div>

                                <div class="d-flex flex-column justify-content-center h-100 position-relative z-index-1 p-5 text-center text-white">
                                    <div class="mb-4">
                                        <div class="brand-icon mx-auto mb-4">
                                            <i class="fas fa-user-plus fa-3x"></i>
                                        </div>
                                        <h2 class="fw-bold mb-3 welcome-text">Bem-vindo!</h2>
                                        <p class="lead opacity-90 mb-0">
                                            Crie sua conta e comece sua jornada conosco.
                                        </p>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Formulário (Lado Direito) -->
                        <div class="col-lg-7">
                            <div class="form-section p-4 p-lg-5">
                                
                                <!-- Header Mobile (ALTERADO AQUI) -->
                                <div class="d-lg-none text-center mb-4">
                                    <div class="brand-icon-mobile mx-auto mb-3">
                                        <i class="fas fa-user-plus fa-2x text-white"></i>
                                    </div>
                                    <h3 class="fw-bold text-dark mb-2">Criar Conta</h3>
                                    <!-- Nova descrição adicionada abaixo -->
                                    <p class="text-muted mb-0">Preencha os campos abaixo para se cadastrar</p>
                                </div>

                                <!-- Header Desktop -->
                                <div class="d-none d-lg-block mb-4">
                                    <h3 class="fw-bold text-dark mb-2">Criar sua conta</h3>
                                    <p class="text-muted mb-0">Preencha os campos abaixo para se registrar</p>
                                </div>

                                <!-- Mensagens de Erro/Sucesso -->
                                {% if messages %}
                                <div class="mb-4">
                                    {% for message in messages %}
                                    <div class="alert modern-alert alert-{{ message.tags|default:'info' }}">
                                        <i class="fas {% if message.tags == 'error' %}fa-exclamation-circle{% elif message.tags == 'success' %}fa-check-circle{% else %}fa-info-circle{% endif %} me-2"></i>
                                        {{ message }}
                                    </div>
                                    {% endfor %}
                                </div>
                                {% endif %}

                                <!-- Formulário -->
                                <form method="post" novalidate>
                                    {% csrf_token %}

                                    <!-- Nome e Sobrenome -->
                                    <div class="row mb-3">
                                        <div class="col-md-6 mb-3 mb-md-0">
                                            <div class="form-floating">
                                                {{ form.first_name }}
                                                <label for="{{ form.first_name.id_for_label }}">
                                                    <i class="fas fa-user me-2 text-primary"></i>Nome
                                                </label>
                                            </div>
                                            {% if form.first_name.errors %}
                                            <div class="error-message">{% for error in form.first_name.errors %}<small><i class="fas fa-exclamation-circle me-1"></i>{{ error }}</small>{% endfor %}</div>
                                            {% endif %}
                                        </div>
                                        <div class="col-md-6">
                                            <div class="form-floating">
                                                {{ form.last_name }}
                                                <label for="{{ form.last_name.id_for_label }}">
                                                    <i class="fas fa-user-tag me-2 text-primary"></i>Sobrenome
                                                </label>
                                            </div>
                                            {% if form.last_name.errors %}
                                            <div class="error-message">{% for error in form.last_name.errors %}<small><i class="fas fa-exclamation-circle me-1"></i>{{ error }}</small>{% endfor %}</div>
                                            {% endif %}
                                        </div>
                                    </div>

                                    <!-- Username -->
                                    <div class="mb-3">
                                        <div class="form-floating">
                                            {{ form.username }}
                                            <label for="{{ form.username.id_for_label }}">
                                                <i class="fas fa-at me-2 text-primary"></i>Nome de usuário
                                            </label>
                                        </div>
                                        <div id="username-validation-message" class="validation-message"></div>
                                        {% if form.username.errors %}
                                        <div class="error-message">{% for error in form.username.errors %}<small><i class="fas fa-exclamation-circle me-1"></i>{{ error }}</small>{% endfor %}</div>
                                        {% endif %}
                                    </div>

                                    <!-- Email -->
                                    <div class="mb-3">
                                        <div class="form-floating">
                                            {{ form.email }}
                                            <label for="{{ form.email.id_for_label }}">
                                                <i class="fas fa-envelope me-2 text-primary"></i>Email
                                            </label>
                                        </div>
                                        <div id="email-validation-message" class="validation-message"></div>
                                        {% if form.email.errors %}
                                        <div class="error-message">{% for error in form.email.errors %}<small><i class="fas fa-exclamation-circle me-1"></i>{{ error }}</small>{% endfor %}</div>
                                        {% endif %}
                                    </div>

                                    <!-- Senha -->
                                    <div class="mb-3">
                                        <div class="form-floating password-field">
                                            {{ form.password1 }}
                                            <label for="{{ form.password1.id_for_label }}">
                                                <i class="fas fa-lock me-2 text-primary"></i>Senha
                                            </label>
                                            <button type="button" class="password-toggle" id="togglePassword1"><i class="fas fa-eye"></i></button>
                                        </div>
                                        
                                        <div id="passwordStrength" class="password-strength d-none">
                                            <div class="strength-bars">
                                                <div class="strength-bar"></div><div class="strength-bar"></div><div class="strength-bar"></div><div class="strength-bar"></div>
                                            </div>
                                            <small id="passwordStrengthText" class="strength-text">Força da senha</small>
                                        </div>
                                        
                                        {% if form.password1.errors %}
                                        <div class="error-message">{% for error in form.password1.errors %}<small><i class="fas fa-exclamation-circle me-1"></i>{{ error }}</small>{% endfor %}</div>
                                        {% endif %}
                                        
                                        <div class="password-requirements">
                                            <small class="text-muted"><i class="fas fa-info-circle me-1"></i>Mínimo 8 caracteres, inclua letras e números</small>
                                        </div>
                                    </div>

                                    <!-- Confirmar Senha -->
                                    <div class="mb-4">
                                        <div class="form-floating password-field">
                                            {{ form.password2 }}
                                            <label for="{{ form.password2.id_for_label }}">
                                                <i class="fas fa-lock me-2 text-primary"></i>Confirmar senha
                                            </label>
                                            <button type="button" class="password-toggle" id="togglePassword2"><i class="fas fa-eye"></i></button>
                                        </div>
                                        
                                        <div id="passwordMatch" class="password-match success d-none"><small><i class="fas fa-check-circle me-1"></i>Senhas coincidem</small></div>
                                        <div id="passwordMismatch" class="password-match error d-none"><small><i class="fas fa-times-circle me-1"></i>Senhas não coincidem</small></div>
                                        
                                        {% if form.password2.errors %}
                                        <div class="error-message">{% for error in form.password2.errors %}<small><i class="fas fa-exclamation-circle me-1"></i>{{ error }}</small>{% endfor %}</div>
                                        {% endif %}
                                    </div>

                                    <!-- Termos -->
                                    <div class="form-check mb-4">
                                        <input class="form-check-input" type="checkbox" id="termsAgree" required>
                                        <label class="form-check-label" for="termsAgree">Concordo com os <a href="#" class="text-primary text-decoration-none">Termos de Serviço</a> e <a href="#" class="text-primary text-decoration-none">Política de Privacidade</a></label>
                                    </div>

                                    <!-- Botão Submit -->
                                    <div class="d-grid mb-4">
                                        <button type="submit" class="btn btn-primary btn-modern" id="registerButton" disabled>
                                            <span class="d-flex align-items-center justify-content-center">
                                                <span class="btn-text">Criar conta</span>
                                                <i class="fas fa-arrow-right ms-2"></i>
                                            </span>
                                        </button>
                                    </div>
                                </form>

                                <div class="text-center">
                                    <div class="divider"><span>ou continue com</span></div>

                                    <!-- Google Login -->
                                    <div class="d-grid mb-4">
                                        <a href="{% provider_login_url 'google' %}" class="btn btn-google-modern">
                                            <svg version="1.1" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 48 48" class="google-icon">
                                                <path fill="#EA4335" d="M24 9.5c3.54 0 6.71 1.22 9.21 3.6l6.85-6.85C35.9 2.38 30.47 0 24 0 14.62 0 6.51 5.38 2.56 13.22l7.98 6.19C12.43 13.72 17.74 9.5 24 9.5z"></path>
                                                <path fill="#4285F4" d="M46.98 24.55c0-1.57-.15-3.09-.42-4.55H24v8.51h12.8c-.57 2.76-2.26 5.23-4.78 6.81l7.68 5.95c4.52-4.18 7.27-10.24 7.27-17.72z"></path>
                                                <path fill="#FBBC05" d="M10.53 28.59c-.48-1.45-.76-2.99-.76-4.59s.27-3.14.76-4.59l-7.98-6.19C.92 16.46 0 20.12 0 24c0 3.88.92 7.54 2.56 10.78l7.97-6.19z"></path>
                                                <path fill="#34A853" d="M24 48c6.48 0 11.93-2.13 15.89-5.82l-7.68-5.95c-2.18 1.45-4.94 2.3-8.21 2.3-6.26 0-11.57-4.22-13.47-9.91l-7.98 6.19C6.51 42.62 14.62 48 24 48z"></path>
                                                <path fill="none" d="M0 0h48v48H0z"></path>
                                            </svg>
                                            <span>Cadastre-se com o Google</span>
                                        </a>
                                    </div>

                                    <p class="mb-0 text-muted">
                                        Já tem uma conta? 
                                        <a href="{% url 'login' %}" class="signup-link">
                                            Faça login
                                        </a>
                                    </p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
/* CSS Variáveis */
:root {
    --primary: #6a3ea1;
    --primary-dark: #4a2c75;
    --primary-light: #8e5bb8;
    --text-muted: #6c757d;
    --border-color: #e9ecef;
    --shadow-light: 0 2px 10px rgba(0, 0, 0, 0.05);
    --shadow-medium: 0 4px 20px rgba(0, 0, 0, 0.08);
    --shadow-strong: 0 8px 30px rgba(106, 62, 161, 0.15);
}

/* Card Principal */
.modern-card {
    border: none;
    border-radius: 24px;
    box-shadow: var(--shadow-strong);
    background: #ffffff;
}

/* Painel Esquerdo (Desktop) */
.left-panel {
    background: linear-gradient(135deg, var(--primary-dark) 0%, var(--primary) 100%);
    position: relative;
    height: 100%;
}

.geometric-patterns {
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: url("data:image/svg+xml,%3Csvg width='60' height='60' viewBox='0 0 60 60' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='none' fill-rule='evenodd'%3E%3Cg fill='%23ffffff' fill-opacity='0.1'%3E%3Ccircle cx='30' cy='30' r='2'/%3E%3C/g%3E%3C/g%3E%3C/svg%3E") repeat;
}

.brand-icon {
    width: 100px;
    height: 100px;
    background: rgba(255, 255, 255, 0.1);
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    backdrop-filter: blur(10px);
    border: 1px solid rgba(255, 255, 255, 0.2);
}
.brand-icon i { color: white; }
.welcome-text { text-shadow: none; }

/* Ícone Mobile */
.brand-icon-mobile {
    width: 60px;
    height: 60px;
    background: linear-gradient(135deg, var(--primary-dark) 0%, var(--primary) 100%);
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
}

/* Inputs e Formulário */
.form-section { background: #ffffff; height: 100%; }

.form-floating { position: relative; margin-bottom: 0.5rem; }

.form-floating > .form-control {
    height: 58px;
    border: 2px solid var(--border-color);
    border-radius: 12px;
    font-size: 1rem;
    transition: all 0.3s ease;
    background: #ffffff;
    padding: 1.625rem 1rem 0.625rem;
}

.form-floating > .form-control:focus {
    border-color: var(--primary);
    box-shadow: 0 0 0 3px rgba(106, 62, 161, 0.1);
    outline: none;
}

.form-floating > label {
    padding: 1rem;
    color: var(--text-muted);
    font-weight: 500;
}

/* Alerts */
.modern-alert {
    border: none;
    border-radius: 12px;
    padding: 16px 20px;
    font-size: 14px;
}
.modern-alert.alert-error, .modern-alert.alert-danger { background: rgba(220, 53, 69, 0.1); color: #dc3545; }
.modern-alert.alert-success { background: rgba(25, 135, 84, 0.1); color: #198754; }
.modern-alert.alert-info { background: rgba(13, 202, 240, 0.1); color: #0dcaf0; }

/* Utilitários Senha */
.password-toggle {
    position: absolute;
    right: 15px; top: 50%; transform: translateY(-50%);
    background: none; border: none; color: var(--text-muted);
    cursor: pointer; z-index: 10; padding: 5px;
}
.password-toggle:hover { color: var(--primary); }

.strength-bars { display: flex; gap: 4px; margin: 8px 0 4px; }
.strength-bar { height: 4px; flex: 1; background: #e9ecef; border-radius: 2px; transition: all 0.3s; }
.strength-bars.weak .strength-bar:first-child { background: #dc3545; }
.strength-bars.medium .strength-bar:nth-child(-n+2) { background: #ffc107; }
.strength-bars.strong .strength-bar:nth-child(-n+3) { background: #198754; }
.strength-bars.very-strong .strength-bar { background: #198754; }
.strength-text, .password-match, .error-message, .validation-message { font-size: 12px; font-weight: 500; margin-top: 4px; }
.password-match.success, .validation-message.success { color: #198754; }
.password-match.error, .error-message, .validation-message.error { color: #dc3545; }

/* Botões */
.btn-modern {
    padding: 16px 24px;
    border-radius: 12px;
    font-weight: 600;
    font-size: 16px;
    border: none;
    background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
    box-shadow: var(--shadow-medium);
    transition: all 0.3s ease;
    width: 100%;
}
.btn-modern:not([disabled]):hover {
    transform: translateY(-2px);
    box-shadow: var(--shadow-strong);
    background: linear-gradient(135deg, var(--primary-dark) 0%, var(--primary) 100%);
}
.btn-modern[disabled] { opacity: 0.6; cursor: not-allowed; }

.divider { position: relative; text-align: center; margin: 32px 0; color: var(--text-muted); font-size: 14px; }
.divider::before { content: ''; position: absolute; top: 50%; left: 0; right: 0; height: 1px; background: var(--border-color); }
.divider span { position: relative; background: white; padding: 0 20px; }

.btn-google-modern {
    padding: 16px 24px;
    border-radius: 12px;
    font-weight: 600;
    font-size: 16px;
    text-decoration: none;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 12px;
    background-color: #ffffff;
    color: #3c4043;
    border: 2px solid var(--border-color);
    box-shadow: var(--shadow-light);
    transition: all 0.3s ease;
}
.btn-google-modern:hover {
    transform: translateY(-2px);
    box-shadow: var(--shadow-medium);
    border-color: #c6c6c6;
    background-color: #f8f9fa;
}
.google-icon { width: 20px; height: 20px; }
.signup-link { color: var(--primary); text-decoration: none; font-weight: 600; }
.signup-link:hover { color: var(--primary-dark); }

/* Responsividade */
@media (max-width: 992px) { .form-section { padding: 40px 30px !important; } }
@media (max-width: 576px) { .form-section { padding: 30px 20px !important; } .modern-card { border-radius: 16px; } }

/* Animação */
.modern-card { animation: slideUp 0.6s ease-out; }
@keyframes slideUp { from { opacity: 0; transform: translateY(30px); } to { opacity: 1; transform: translateY(0); } }
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const inputs = {
        firstName: document.getElementById('{{ form.first_name.id_for_label }}'),
        lastName: document.getElementById('{{ form.last_name.id_for_label }}'),
        username: document.getElementById('{{ form.username.id_for_label }}'),
        email: document.getElementById('{{ form.email.id_for_label }}'),
        password1: document.getElementById('{{ form.password1.id_for_label }}'),
        password2: document.getElementById('{{ form.password2.id_for_label }}')
    };

    const elements = {
        termsCheckbox: document.getElementById('termsAgree'),
        registerButton: document.getElementById('registerButton'),
        passwordStrength: document.getElementById('passwordStrength'),
        strengthBars: document.querySelector('.strength-bars'),
        strengthText: document.getElementById('passwordStrengthText'),
        passwordMatch: document.getElementById('passwordMatch'),
        passwordMismatch: document.getElementById('passwordMismatch')
    };

    // Estilo inicial
    Object.values(inputs).forEach(input => {
        if (input) {
            input.classList.add('form-control');
            input.setAttribute('placeholder', ' ');
        }
    });

    // Validação Visual
    function showValidationMessage(elementId, message, isError) {
        const el = document.getElementById(elementId);
        if (el) {
            el.innerHTML = message;
            el.className = 'validation-message';
            if (message) el.classList.add(isError ? 'error' : 'success');
        }
    }

    async function validateField(inputElement, fieldName) {
        const value = inputElement.value.trim();
        const messageContainerId = `${fieldName}-validation-message`;

        if (value.length < 3) {
            showValidationMessage(messageContainerId, '', false);
            inputElement.style.borderColor = 'var(--border-color)';
            return;
        }

        try {
            const response = await fetch('/api/validate-field/', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'X-CSRFToken': '{{ csrf_token }}' },
                body: JSON.stringify({ field_name: fieldName, field_value: value })
            });

            if (!response.ok) throw new Error('Network error');
            const data = await response.json();
            const label = fieldName === 'username' ? 'Nome de usuário' : 'Email';

            if (data.is_taken) {
                showValidationMessage(messageContainerId, `<i class="fas fa-times-circle me-1"></i>${label} já está em uso.`, true);
                inputElement.style.borderColor = '#dc3545';
            } else {
                showValidationMessage(messageContainerId, `<i class="fas fa-check-circle me-1"></i>${label} disponível!`, false);
                inputElement.style.borderColor = '#198754';
            }
        } catch (error) { console.error('Validation error:', error); }
    }

    if (inputs.username) inputs.username.addEventListener('blur', () => validateField(inputs.username, 'username'));
    if (inputs.email) inputs.email.addEventListener('blur', () => validateField(inputs.email, 'email'));

    // Toggle Password
    function setupPasswordToggle(toggleId, passwordInput) {
        const toggle = document.getElementById(toggleId);
        if (toggle && passwordInput) {
            toggle.addEventListener('click', function() {
                const type = passwordInput.type === 'password' ? 'text' : 'password';
                passwordInput.type = type;
                const icon = this.querySelector('i');
                icon.classList.toggle('fa-eye');
                icon.classList.toggle('fa-eye-slash');
            });
        }
    }
    setupPasswordToggle('togglePassword1', inputs.password1);
    setupPasswordToggle('togglePassword2', inputs.password2);

    // Força da Senha
    if (inputs.password1 && elements.passwordStrength) {
        inputs.password1.addEventListener('input', function() {
            const password = this.value;
            if (password.length === 0) { elements.passwordStrength.classList.add('d-none'); return; }
            elements.passwordStrength.classList.remove('d-none');

            let score = 0;
            if (password.length >= 8) score++;
            if (/[a-z]/.test(password)) score++;
            if (/[A-Z]/.test(password)) score++;
            if (/[0-9]/.test(password)) score++;
            if (/[^a-zA-Z0-9]/.test(password)) score++;

            elements.strengthBars.className = 'strength-bars';
            elements.strengthText.className = 'strength-text';

            if (score <= 2) {
                elements.strengthBars.classList.add('weak');
                elements.strengthText.classList.add('text-danger');
                elements.strengthText.innerHTML = 'Fraca';
            } else if (score === 3) {
                elements.strengthBars.classList.add('medium');
                elements.strengthText.classList.add('text-warning');
                elements.strengthText.innerHTML = 'Média';
            } else {
                elements.strengthBars.classList.add('strong');
                elements.strengthText.classList.add('text-success');
                elements.strengthText.innerHTML = 'Forte';
            }
        });
    }

    // Match Senha
    function checkPasswordMatch() {
        if (!inputs.password1 || !inputs.password2) return;
        const p1 = inputs.password1.value;
        const p2 = inputs.password2.value;

        if (p2.length === 0) {
            elements.passwordMatch?.classList.add('d-none'); elements.passwordMismatch?.classList.add('d-none'); return;
        }

        if (p1 === p2) {
            elements.passwordMatch?.classList.remove('d-none'); elements.passwordMismatch?.classList.add('d-none');
        } else {
            elements.passwordMatch?.classList.add('d-none'); elements.passwordMismatch?.classList.remove('d-none');
        }
    }
    if (inputs.password1 && inputs.password2) {
        inputs.password1.addEventListener('input', checkPasswordMatch);
        inputs.password2.addEventListener('input', checkPasswordMatch);
    }

    // Checkbox
    if (elements.termsCheckbox && elements.registerButton) {
        elements.termsCheckbox.addEventListener('change', function() {
            elements.registerButton.disabled = !this.checked;
        });
    }
});
</script>
{% endblock %}